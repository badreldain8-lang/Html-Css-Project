<script>
// 1. Create the "Walkie-Talkie" channel
const cartChannel = new BroadcastChannel('cart_updates');

function updateCartCount(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const count = cart.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
  document.getElementById("cartCount").innerText = count;
}

// 2. Listen for messages from the Cart page
cartChannel.onmessage = (event) => {
  if (event.data === 'update') {
    updateCartCount();
  }
};

function addToCart(name, price, img){
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  const index = cart.findIndex(item => item.name === name);
  if(index !== -1){
    cart[index].qty++;
  } else {
    cart.push({name, price, img, qty:1});
  }
  localStorage.setItem("cart", JSON.stringify(cart));
  
  updateCartCount();
  // Tell other pages to update too
  cartChannel.postMessage('update');
}

function openCart(){
  window.location.href = "cart.html";
}

// Check every time page is visible
window.addEventListener('pageshow', updateCartCount);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') updateCartCount();
});

updateCartCount();
</script>
