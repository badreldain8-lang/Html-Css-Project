<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</title>
<style>
body { font-family: Arial; background:#f5f5f5; margin:0; padding:20px; direction: rtl; }
h1 { text-align:center; }
#items { margin-top:20px; }
.item { display:flex; justify-content:space-between; align-items:center; background:#fff; margin-bottom:10px; padding:10px; border-radius:5px; }
.item-left { display:flex; align-items:center; }
.item-left img { width:50px; height:50px; margin-left:10px; }
.qty-controls { display:flex; align-items:center; }
.qty-controls button { margin:0 5px; padding:5px 10px; cursor:pointer; }
.qty-controls input { width:30px; text-align:center; }
.cart-icon { position:fixed; top:10px; left:10px; background:red; color:white; border-radius:50%; padding:5px 10px; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<h1>Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>

<select id="governorate">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
  <option value="cairo">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
  <option value="giza">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
  <option value="alex">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
  <option value="other">Ø£Ø®Ø±Ù‰</option>
</select>

<div id="items"></div>

<p>Ø§Ù„Ø´Ø­Ù†: <span id="shipping">0</span> Ø¬Ù†ÙŠÙ‡</p>
<p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡</p>

<button onclick="goCheckout()">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

<div class="cart-icon" onclick="openCart()">
  ğŸ›’ <span id="cartCount">0</span>
</div>

<script>
// 1. Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø§Ù„Ù„Ø§Ø³Ù„ÙƒÙŠ)
const cartChannel = new BroadcastChannel('cart_updates');

let box = document.getElementById("items");

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
function updateCartIcon(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const count = cart.reduce((sum,item)=>sum + (Number(item.qty) || 0),0);
  document.getElementById("cartCount").innerText = count;
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù„Ø©
function render(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  let subtotal = 0;
  let shippingCost = 0;
  box.innerHTML = "";

  if(cart.length === 0){
    box.innerHTML = "<p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©</p>";
  } else {
    cart.forEach((item, i)=>{
      subtotal += item.price * item.qty;

      const p = document.createElement("div");
      p.classList.add("item");
      p.innerHTML = `
        <div class="item-left">
          <img src="${item.img}" alt="${item.name}">
          <span>${item.name} - ${item.price} Ø¬Ù†ÙŠÙ‡</span>
        </div>
        <div class="qty-controls">
          <button class="decrease">-</button>
          <input type="text" value="${item.qty}" readonly>
          <button class="increase">+</button>
          <button class="remove">âŒ</button>
        </div>
      `;
      box.appendChild(p);

      // Ø²Ø± Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
      p.querySelector(".increase").addEventListener("click", ()=>{
        cart[i].qty++;
        saveAndUpdate(cart);
      });

      // Ø²Ø± Ø§Ù„Ù†Ù‚Øµ
      p.querySelector(".decrease").addEventListener("click", ()=>{
        if(cart[i].qty > 1){
          cart[i].qty--;
        } else {
          cart.splice(i,1);
        }
        saveAndUpdate(cart);
      });

      // Ø²Ø± Ø§Ù„Ø­Ø°Ù
      p.querySelector(".remove").addEventListener("click", ()=>{
        cart.splice(i,1);
        saveAndUpdate(cart);
      });
    });
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø­Ù†
  const gov = document.getElementById("governorate").value || "";
  shippingCost = gov==='cairo'?50:gov==='giza'?60:gov==='alex'?70:gov==='other'?80:0;

  document.getElementById("shipping").innerText = shippingCost;
  document.getElementById("total").innerText = subtotal + shippingCost;

  updateCartIcon();
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ØµÙØ­Ø© Ø§Ù„Ù€ Index
function saveAndUpdate(cartArray) {
  localStorage.setItem("cart", JSON.stringify(cartArray));
  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
  cartChannel.postMessage('update'); 
  render();
}

document.getElementById("governorate").addEventListener("change", render);

function goCheckout(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const gov = document.getElementById("governorate").value;
  if(cart.length===0){
    alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©");
    return;
  }
  if(!gov){
    alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  localStorage.setItem("selectedGovernorate", gov);
  window.location.href="checkout.html";
}

function openCart(){
  render();
}

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ùˆ ØªÙ… ØªØºÙŠÙŠØ± Ø´ÙŠØ¡ Ù…Ù† ØªØ§Ø¨ Ø¢Ø®Ø±
cartChannel.onmessage = (event) => {
  if (event.data === 'update') {
    render();
  }
};

// Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ (Ù„Ù„Ø®Ù„Ù ÙˆÙ„Ù„Ø£Ù…Ø§Ù…)
window.addEventListener('pageshow', render);

render();
</script>

</body>
</html>


